%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Motorky, serva a~PWM}

\subsection{Motorky}

Motorek připojujeme vždy přes    \hyperlink{tranzistor}{tranzistor}. 
Pokud chceme řídit motorek z~čipu stylem start -- stop, postačí přes odpor 
např. 1~k$\Omega$ spojit výstupní pin čipu s~bází tranzistoru a~na emitor a~kolektor připojit baterii a motorek zapojený do série. 

Dále je potřeba bázi tranzistoru propojit pomocí např. 10~k$\Omega$ se zemí. 
Jinak totiž při vypnutém signálu z čipu báze \uv{visí v luftě} a chová se jako 
anténa -- indukují se na ní různé signály a většinou se díky tomu motorek samovolně slabě otáčí.   

Nakonec je potřeba mít společnou zem pro čip i pro motorek -- pokud to není splněno, obvykle motorek nejede. 

Pro větší motorky potřebujeme lepší tranzitor nebo dva tranzistory v tzv. Darlingtonově zapojení (viz web). 
Další možností jsou speciální integrované obvody pro řízení motorů, tzv.  
 \hyperref[driver]{drivery}, které jsou složeny z mnoha tranzistorů a dalších prvků. 

Pokud chceme řídit motory programově pomocí PWM (viz další kapitola), 
musíme navíc mezi emitor a kolektor tranzistoru vložit (obyčejnou) diodu pólovanou závěrně vůči baterii. 
Při vypnutí tranzistoru vznikají totiž na cívkách motorku napěťové špičky, které deformují tvar PWM signálu.  
Další proudy se indukují, když se motorek po vypnutí proudu setrvačností otáčí dál. 

\subsection{PWM} \label{PWM}  \index{PWM} 

{\bf PWM}  (Pulse Width Modulation) neboli pulzně šířková modulace je učený název pro tzv. obdélníkový signál -- z pinu vychází hodnoty napětí, které zakreslené do grafu mají tvar 
\href{https://www.arduino.cc/en/Tutorial/PWM}{obdélníku}.
 Proč zrovna obdélník? Protože na tranzistorech i driverech jsou při řízení motoru nejmenší ztráty, když jsou zcela otevřené (přenáší maximum napětí nebo proudu) nebo zcela zavřené (nepřenáší nic). Nejmenší ztráty znamenají také nejsnazší možné chlazení. Proto se snažíme stavům mezi oběma krajními mezemi vyhnout a zkrátit je na minimum. 


\label{servo} \subsection{Servo}

{\bf (Modelářské) servo} je krabička, která obsahuje motorek s převodovkou do pomala a řídící elektroniku, která se stará o jeho správné natočení. Obvykle se umí otočit v úhlu 180 stupňů s velkou přesností. Jeho klíčová vlastnost je, že polohu, do které se otočil, se snaží udržet. \index{servo} 

Na desce \hyperref[alks]{ALKS} jsou zapojeny vývody pro pět serv, která lze z desky přímo napájet a řídit. 
Protože servo (jako každý motor) potřebuje hodně proudu, lze přímo z desky napájet pouze nejmenší serva každé zvlášť. Pro větší serva je na desce připraven mini-USB konektor, do kterého je možné připojit samostatné napájení pro serva. 

Pro připojení serv na desku ALKS platí, že GND (zem, mínus) je na okraji desky, 5~V je uprostřed a datový pin je nejblíže čipu. 

{\bf Pozor!} Servo nesnáší přepólování napětí, když se přepóluje, tak shoří (když se přepóluje signál, tak to tolik nevadí).

\subsection{Řízení serva}

\index{servo} Jak se řídí pohyb serva? Pro tento účel je ideální právě generování PWM signálu. 

Servo se řídí logickým signálem (jedničkou) po dobu od 1~ms do 2~ms (často i~od 0,5~ms do 2,5~ms), 
a~celková perioda je 20~ms. Podle toho, jak dlouho signál trvá, tak se servo natočí. 
Tj. pokud budeme chtít servo maximálně natočit na jednu stranu, nastavíme pin, který 
slouží jako řídící signál pro servo, na logickou jedničku po dobu 1~ms a~pak 19~ms logickou nulu a~pak zase logickou jedničku, logickou nulu, atd... 

Pokud budeme chtít servo posunout do druhé krajní polohy, necháme logickou jedničku po dobu 2~ms a~logickou nulu po dobu 18~ms. 
Pokud budeme chtít střední polohu, tak jedničku nastavíme na 1,5~ms a~nulu na 18,5~ms. 
Jestliže budeme potřebovat jiný úhel natočení, nastavíme logickou jedničku na odpovídající dobu.

Jednoduchý program pro řízení serva je v kapitole \ref{prog:servo}.


\section{Řídící desky}

\label{esp32} \subsection{ESP 32}

Deska\index{ESP~32!deska}\index{deska!ESP~32} {\bf ESP~32}  je vývojová deska osazená čipem {\tt ESP-WROOM-32}, který má řadu výborných vlastností.\footnote{\url{http://navody.arduino-shop.cz/navody-k-produktum/vyvojova-deska-esp32.html} }

Deska se napájí z~\index{USB} USB (5~V) a~je na ní napěťový převodník
%todo\rfc{? napěťový převodník} 
na 3,3~V. Přitom USB může dodávat oficiálně 100~mA, v~reálu ale běžně dodává 500~mA až 1 A. USB porty jsou také vcelku odolné proti zkratu.   

\label{alks} \subsection{ALKS} 

Deska ALKS\footnote{Arduion Learning Kit Starter} byla navržena přímo na Robotárně Brno právě proto, že 
hotová\index{ALKS/deska}\index{deska/ALKS} deska   
vás hlavně ze začátku zbavuje nutnosti vědět, co si můžete dovolit kam připojit a~jestli to bude fungovat. 

Na ALKS se dají nasadit desky ESP~32, Arduino uno  a~Arduino nano, které jí také poskytují napájení.  

{\bf POZOR !} Při připojování čehokoliv dalšího k~této nebo jiné desce si nechte před zapojením napájení všechno zkontrolovat. Hlavně, pokud připojovaná součástka spotřebuje víc proudu (serva a~motory) nebo pokud vyžaduje vyšší napětí. 

\label{alks:knihovna} \subsubsection*{ALKS a ESP~32}

Pro nasazení desky   \hyperref[esp32]{ESP~32}
 na ALKS byla \index{LearningKit} napsaná knihovna {\it LearningKit}. 
Aby fungovala, musí být do souboru {\it platformio.ini} dopsán řádek 
{\tt lib\_deps = 1745} (bez mezery na začátku řádku) a~do záhlaví souboru {\it main.cpp} doplňte 
\verb| include "LearningKit.h"|.
% {\tt include "LearningKit.h\"}.  
% je nahrazeno \verb| include "LearningKit.h"| , protože \tt tady nějak nefunguje 
 -- viz obrázek \ref{fig:vsc_rozlozeni} vpravo.
%todo zjistit, if lze LearningKit přidat přímo jako LearningKit_nano

\label{alks:nano} \subsubsection*{ALKS a Arduino nano}

Pro nasazení desky Arduino nano\footnote{\url{https://store.arduino.cc/usa/arduino-nano}} 
na ALKS byla \index{LearningKit} napsaná knihovna \newline
{\tt LearningKit\_nano.h}. 
Aby fungovala, musí být v záhlaví souboru {\it main.cpp} doplněno
\verb| include "LearningKit_nano.h"|. Protože knihovna \newline {\tt LearningKit\_nano.h} využívá 
knihovnu {\tt LearningKit.h}, musí být také do souboru {\it platformio.ini} dopsán řádek {\tt lib\_deps = 1745} (bez mezery na začátku řádku)  -- viz obrázek \ref{fig:vsc_rozlozeni} vpravo.



\subsubsection*{Dokumentace k ALKS}

Stránky  věnované desce ALKS jsou
 \href{https://github.com/RoboticsBrno/ArduinoLearningKitStarter}{zde}.

Zapojení desky ALKS je \href{https://github.com/RoboticsBrno/ArduinoLearningKitStarter/blob/master/docs/ArduinoLearningKitStarter.pdf}{zde}.

Zapojení pinů desky ALKS \href{https://github.com/RoboticsBrno/ArduinoLearningKitStarter/blob/master/docs/pinout.pdf}{zde}. 


\subsection{RBControl} \index{RBControl}

\subsubsection*{Určení a cíl}

RB3201 - RBControl (RBC) je univerzální deska pro stavbu hobby robotů, vyvinutá na Robotárně Brno. 
Jde v podstatě o shield k desce ESP32 dev kit, který má dva hlavní cíle: 
rozšířit počet pinů desky ESP32 a umožnit snadné připojení velkého množství různých periférií.

\subsubsection*{Hlavní vlastnosti}

Deska RBC umožňuje současně ovládat až 8 DC motorů (1,5 A trvale, 2A špičkově každý). 
Dále umí po osazení spínanými zdroji napájet a ovládat 4 serva nebo 8 mikroserv. 
Má vyvedenou I2C sběrnici celkem 6x na 3,3 V a 2x na 5 V. 
Dále je na desce expandér pinů, který je připojený na I2C a obsluhuje další dva porty A,B po 8 pinech. 
Na desce jsou vyvedená tři tlačítka, 4 LED a piezo.

Podrobnější popis desky je zde %todo 

\subsection{Arduino Mega}

Největší deska z rodiny Arduino. Má vyvedených 100 pinů a může obsluhovat tři sériové linky. 
Hodí se pro větší projekty a jako hlavní řídící deska na robota. 
Hlavní výhoda (stejně jako ostatních desek rodiny Arduino) je, že se dá koupit levně hotová.
Schéma zapojení pinů je například \href{https://arduino-info.wikispaces.com/MegaQuickRef}{zde}.

\subsection{Arduino Uno}

Základní deska z rodiny Arduino. Vhodná na testování různých zapojení a jako řídící pro jednodušší projekty.
Schéma zapojení pinů je například \href{http://forum.arduino.cc/index.php?topic=146315.0}{zde}.

\subsection{Arduino Nano}

Nejmenší deska z rodiny Arduino. 
Hodí se tam, kde je je málo místa a pro řešení jednodušších, relativně samostatných úloh. 
Schéma zapojení pinů je například \href{https://simba-os.readthedocs.io/en/latest/_images/arduino-nano-pinout.png}{zde}.

\section{Senzory a malé desky}

\label{hcsr04} \subsection{Ultrazvukový senzor HC-SR04} \index{HC-SR04}

Ultrazvukový senzor {\bf HC-SR04}\footnote{\url{https://www.sparkfun.com/products/13959}} \index{HC-SR04} je cenově dostupný a běžně používaný při amatérské stavbě robotů. \index{senzor!ultrazvukový}
\index{ultrazvukový senzor} 
Jeho zapojení a oživení je 
  \href{https://randomnerdtutorials.com/complete-guide-for-ultrasonic-sensor-hc-sr04/}{zde}.


%lit: http://www.instructables.com/id/Simple-Arduino-and-HC-SR04-Example/

\subsection{Bluetooth} \index{bluetooth}


\hypertarget{bluetooth}{} Moduly {\bf bluetooth} slouží ke komunikaci mezi dvěma čipy nebo počítačem a čipem (nebo jiným zařízením).
Mohou být napájeny 5~V nebo 3,3~V. 
\label{bluetooth} 

Propojujeme vždy pin Rx na jednom čipu s pinem Tx na druhém čipu. 

\subsubsection*{Připojení k počítači pomocí bluetooth}

Nový bluetooth (zub) se musí napoprvé vyhledat a aktivovat v počítači. 
Pokaždé se musí připojit a zkontrolovat -- když je komunikace v~pořádku (aktivována, ale nemusí se přenášet data ), svítí LED na zubu. 
Když je v pořádku modul v počítači, tak bliká.  

Dále musí být spojená země zubu a čipu.

%todo Kód zubů: 0007 - uvádět do veřejného textu?


